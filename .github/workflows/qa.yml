name: QA (Playwright + a11y + perf + links)

on:
  push:
  pull_request:

jobs:
  qa:
    runs-on: ubuntu-latest

    services:
      mongo:
        image: mongo:7
        ports: ['27017:27017']
        options: >-
          --health-cmd="mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval=10s --health-timeout=5s --health-retries=10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps
        run: npm ci

      - name: Seed database (best-effort)
        run: |
          node setup-freshshare-db.js || true
          node seed.js || true

      - name: Create .env file for CI
        run: |
          cat > .env << EOF
          PORT=3002
          NODE_ENV=test
          MONGODB_URI=mongodb://127.0.0.1:27017/freshshare_ci
          JWT_SECRET=testsecret
          USDA_API_KEY=test_key_for_ci
          SESSION_SECRET=test_session_secret
          EOF

      - name: Start app
        run: |
          node server.js > server.log 2>&1 &
          echo "Server started with PID $!"
          sleep 5

      - name: Check server logs
        if: always()
        run: |
          echo "=== Server logs ==="
          cat server.log || echo "No server logs found"

      - name: Wait for http://127.0.0.1:3002
        run: npx wait-on http://127.0.0.1:3002 --timeout 60000

      # ---- Broken links crawl
      - name: Broken links (linkinator)
        run: npx linkinator http://127.0.0.1:3002 --recurse --skip "mailto:,tel:"

      # ---- Playwright (E2E + axe)
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
      - name: Run Playwright tests
        run: npx playwright test
      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report
          if-no-files-found: ignore

      # ---- Lighthouse CI (performance & a11y categories)
      - name: Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        with:
          configPath: "./lighthouserc.json"
          uploadArtifacts: true
          temporaryPublicStorage: true
