name: QA (Playwright + a11y + perf + links)

on:
  push:
  pull_request:

jobs:
  qa:
    runs-on: ubuntu-latest

    services:
      mongo:
        image: mongo:7
        ports: ['27017:27017']
        options: >-
          --health-cmd="mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval=10s --health-timeout=5s --health-retries=10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps
        run: npm ci

      - name: Seed database (best-effort)
        run: |
          node setup-freshshare-db.js || true
          node seed.js || true

      - name: Create .env file for CI
        run: |
          cat > .env << EOF
          PORT=3002
          NODE_ENV=ci
          MONGODB_URI=mongodb://127.0.0.1:27017/freshshare_ci
          JWT_SECRET=testsecret
          USDA_API_KEY=test_key_for_ci
          SESSION_SECRET=test_session_secret
          SMTP_HOST=localhost
          SMTP_PORT=587
          SMTP_USER=test@example.com
          SMTP_PASS=testpass
          EMAIL_FROM=noreply@freshshare.test
          EOF
          echo "Created .env file:"
          cat .env

      - name: Start app in background
        run: |
          PORT=3002 NODE_ENV=ci node server.js > server.log 2>&1 &
          SERVER_PID=$!
          echo "Server started with PID $SERVER_PID"
          echo $SERVER_PID > server.pid
          
          # Wait a bit and check if process is still running
          sleep 3
          if kill -0 $SERVER_PID 2>/dev/null; then
            echo "✓ Server process is running"
          else
            echo "✗ Server process died immediately"
            cat server.log
            exit 1
          fi

      - name: Wait for server to be ready
        run: |
          echo "Waiting for server on http://127.0.0.1:3002..."
          npx wait-on http://127.0.0.1:3002 --timeout 30000 --interval 1000 || {
            echo "Server failed to start. Logs:"
            cat server.log
            exit 1
          }
          echo "✓ Server is ready!"

      - name: Show server logs
        if: always()
        run: |
          echo "=== Server logs ==="
          cat server.log 2>/dev/null || echo "No server logs found"

      # ---- Broken links crawl (allow known missing assets)
      - name: Broken links (linkinator)
        continue-on-error: true
        run: |
          npx linkinator http://127.0.0.1:3002 --recurse --skip "mailto:,tel:,/images/,/privacy,/terms" || echo "⚠️ Some broken links found (non-critical)"

      # ---- Playwright (E2E + axe)
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
      - name: Run Playwright tests
        run: npx playwright test
      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report
          if-no-files-found: ignore

      # ---- Lighthouse CI (performance & a11y categories)
      - name: Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        with:
          configPath: "./lighthouserc.json"
          uploadArtifacts: true
          temporaryPublicStorage: true
