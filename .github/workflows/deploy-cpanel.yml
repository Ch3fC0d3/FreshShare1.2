name: Deploy to cPanel

on:
  push:
    branches: [ main, auth-fix ]  # Deploy when pushing to main or auth-fix
  workflow_dispatch:  # Allow manual deployment

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy via SSH and restart Node.js app
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.CPANEL_HOST }}
        username: ${{ secrets.CPANEL_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          # Navigate to app directory
          cd /home/myjrooxo/freshshare1.3
          
          # Initialize git if not already done
          if [ ! -d .git ]; then
            git init
            git remote add origin https://github.com/Ch3fC0d3/Freshshare4.git
          fi
          
          # Pull latest code from GitHub
          git fetch origin
          git reset --hard origin/auth-fix
          
          # Install/update dependencies
          npm install --production
          
          # Create .env file with production settings
          echo "NODE_ENV=production" > .env
          echo "PORT=3001" >> .env
          echo "MONGODB_URI=${{ secrets.MONGODB_URI }}" >> .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}" >> .env
          echo "EMAIL_HOST=${{ secrets.EMAIL_HOST }}" >> .env
          echo "EMAIL_PORT=${{ secrets.EMAIL_PORT }}" >> .env
          echo "EMAIL_USER=${{ secrets.EMAIL_USER }}" >> .env
          echo "EMAIL_PASS=${{ secrets.EMAIL_PASS }}" >> .env
          echo "EMAIL_FROM=${{ secrets.EMAIL_FROM }}" >> .env
          
          # Create tmp directory if it doesn't exist
          mkdir -p tmp
          
          # Restart the Node.js application
          touch tmp/restart.txt
          
          # Alternative: Kill and restart the process
          pkill -f "node.*server.js" || echo "No existing process to kill"
          
          # Wait a moment
          sleep 2
          
          # Start the app in background
          NODE_ENV=production PORT=3001 nohup node server.js > server.log 2>&1 &
          
          echo "Deployment completed successfully!"
